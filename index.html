<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ドラクエ風バトルデモ</title>
  <style>
    body {
      background-color: #000000;
      color: #ffffff;
      font-family: "MS Gothic", "Yu Gothic UI", monospace;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    #battle-screen {
      width: 480px;
      background-color: #000000;
      border: 4px solid #ffffff;
      padding: 12px;
      box-sizing: border-box;
    }

    #top-area {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .window {
      border: 2px solid #ffffff;
      padding: 8px;
      box-sizing: border-box;
      min-height: 80px;
    }

    #enemy-window {
      width: 55%;
      margin-right: 4px;
    }

    #status-window {
      width: 45%;
      margin-left: 4px;
      font-size: 14px;
    }

    #message-window {
      margin-top: 8px;
      min-height: 72px;
      font-size: 14px;
    }

    #message-text {
      white-space: pre-line; /* \n を改行として表示 */
    }

    #command-window {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .command-btn {
      flex: 1 1 100px;
      padding: 6px 4px;
      background-color: #000000;
      color: #ffffff;
      border: 2px solid #ffffff;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
    }

    .command-btn:disabled {
      color: #888888;
      border-color: #444444;
      cursor: default;
    }
  </style>
</head>
<body>
  <div id="battle-screen">
    <div id="top-area">
      <div id="enemy-window" class="window">
        <div id="enemy-name"></div>
        <!-- HPは本家っぽく隠しておいても良いが、学習用に表示 -->
        <div id="enemy-hp"></div>
      </div>

      <div id="status-window" class="window">
        <div id="player-name"></div>
        <div id="player-lv"></div>
        <div id="player-hp"></div>
      </div>
    </div>

    <div id="message-window" class="window">
      <div id="message-text"></div>
    </div>

    <div id="command-window">
      <button id="attack-btn" class="command-btn">たたかう</button>
      <button id="run-btn" class="command-btn">にげる</button>
    </div>
  </div>

  <script>
    // ============================
    // データ定義
    // ============================
    const player = {
      name: "やまちゃん",
      level: 1,
      hp: 20,
      maxHp: 20,
      attackMin: 3,
      attackMax: 6
    };

    const enemy = {
      name: "スライム",
      hp: 15,
      maxHp: 15,
      attackMin: 1,
      attackMax: 3
    };

    // ゲームの状態
    // "playerTurn" | "enemyTurn" | "win" | "lose" | "escape"
    let gameState = "playerTurn";
    let inputLocked = false; // 敵ターン中など、入力禁止フラグ

    // ============================
    // DOM の取得
    // ============================
    const enemyNameEl = document.getElementById("enemy-name");
    const enemyHpEl = document.getElementById("enemy-hp");

    const playerNameEl = document.getElementById("player-name");
    const playerLvEl = document.getElementById("player-lv");
    const playerHpEl = document.getElementById("player-hp");

    const messageTextEl = document.getElementById("message-text");

    const attackBtn = document.getElementById("attack-btn");
    const runBtn = document.getElementById("run-btn");

    // ============================
    // ユーティリティ関数
    // ============================
    function getRandomDamage(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function updateStatus() {
      enemyNameEl.textContent = enemy.name;
      enemyHpEl.textContent = "H P : " + enemy.hp + " / " + enemy.maxHp;

      playerNameEl.textContent = player.name;
      playerLvEl.textContent = "L V : " + player.level;
      playerHpEl.textContent = "H P : " + player.hp + " / " + player.maxHp;
    }

    function setMessage(lines) {
      // lines: 文字列 or 文字列配列
      if (Array.isArray(lines)) {
        messageTextEl.textContent = lines.join("\n");
      } else {
        messageTextEl.textContent = lines;
      }
    }

    function lockInput() {
      inputLocked = true;
      attackBtn.disabled = true;
      runBtn.disabled = true;
    }

    function unlockInput() {
      // 戦闘が続いているときだけ有効にする
      if (gameState === "playerTurn") {
        inputLocked = false;
        attackBtn.disabled = false;
        runBtn.disabled = false;
      }
    }

    function endBattle() {
      // 戦闘終了時はコマンドを全て無効化
      attackBtn.disabled = true;
      runBtn.disabled = true;
    }

    // ============================
    // 戦闘ロジック
    // ============================
    function playerAttack() {
      if (inputLocked || gameState !== "playerTurn") return;

      lockInput();

      const damage = getRandomDamage(player.attackMin, player.attackMax);
      enemy.hp -= damage;
      if (enemy.hp < 0) enemy.hp = 0;
      updateStatus();

      setMessage([
        player.name + "の こうげき！",
        enemy.name + "に " + damage + " の ダメージ！"
      ]);

      // 少し待ってから判定 → 敵ターンへ
      setTimeout(() => {
        if (enemy.hp <= 0) {
          gameState = "win";
          setMessage([
            enemy.name + "を たおした！",
            "けいけんち 5P を かくとく！"
          ]);
          endBattle();
        } else {
          gameState = "enemyTurn";
          enemyAttack();
        }
      }, 800);
    }

    function enemyAttack() {
      if (gameState !== "enemyTurn") return;

      const damage = getRandomDamage(enemy.attackMin, enemy.attackMax);
      player.hp -= damage;
      if (player.hp < 0) player.hp = 0;
      updateStatus();

      setMessage([
        enemy.name + "の こうげき！",
        player.name + "は " + damage + " の ダメージを うけた！"
      ]);

      setTimeout(() => {
        if (player.hp <= 0) {
          gameState = "lose";
          setMessage([
            player.name + "は しんでしまった…",
            "めのまえが まっくらに なった。"
          ]);
          endBattle();
        } else {
          // プレイヤーのターンに戻す
          gameState = "playerTurn";
          unlockInput();
          setMessage("コマンド？");
        }
      }, 800);
    }

    function tryEscape() {
      if (inputLocked || gameState !== "playerTurn") return;

      lockInput();

      const escaped = Math.random() < 0.5; // 50%で成功

      if (escaped) {
        gameState = "escape";
        setMessage("うまく にげきれた！");
        endBattle();
      } else {
        setMessage([
          "しかし まわりこまれてしまった！",
          enemy.name + "の こうげき！"
        ]);

        setTimeout(() => {
          gameState = "enemyTurn";
          enemyAttack();
        }, 800);
      }
    }

    // ============================
    // イベント設定
    // ============================
    attackBtn.addEventListener("click", playerAttack);
    runBtn.addEventListener("click", tryEscape);

    // ============================
    // 初期化
    // ============================
    function initBattle() {
      updateStatus();
      setMessage(enemy.name + "が あらわれた！");
      // 開始時点ではプレイヤーターン＆入力OK
      gameState = "playerTurn";
      inputLocked = false;
      attackBtn.disabled = false;
      runBtn.disabled = false;
    }

    initBattle();
  </script>
</body>
</html>
