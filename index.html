<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ドラクエ風バトルデモ（3分割＋EXP）</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: "MS Gothic", "Yu Gothic UI", monospace;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }

    /* 画面全体：3列レイアウト */
    #battle-screen {
      width: 900px;
      height: 400px;
      background-color: #000;
      border: 4px solid #fff;
      padding: 8px;
      box-sizing: border-box;
      display: grid;
      grid-template-columns: 1fr 1.2fr 1fr; /* 左：ステータス 中央：ログ 右：フィールド */
      column-gap: 8px;
    }

    .window {
      border: 2px solid #fff;
      box-sizing: border-box;
      padding: 8px;
      font-size: 14px;
    }

    /* 左：ステータス画面 */
    #status-area {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    #enemy-block {
      margin-bottom: 12px;
      border-bottom: 1px solid #fff;
      padding-bottom: 8px;
    }

    /* 中央：ログビュー＋コマンドビュー */
    #center-area {
      display: flex;
      flex-direction: column;
    }

    #log-view {
      flex: 1;
      margin-bottom: 8px;
      display: flex;
      align-items: flex-start;
    }

    #message-text {
      white-space: pre-line;
    }

    #command-view {
      height: 90px;
      display: flex;
      gap: 8px;
      align-items: stretch;
      justify-content: flex-start;
    }

    .command-btn {
      flex: 0 0 110px;
      padding: 6px 4px;
      background-color: #000;
      color: #fff;
      border: 2px solid #fff;
      cursor: pointer;
      font-family: inherit;
      font-size: 14px;
    }

    .command-btn:disabled {
      color: #888;
      border-color: #444;
      cursor: default;
    }

    /* 右：フィールド画面 */
    #field-area {
      position: relative;
    }

    #field-label {
      position: absolute;
      top: 4px;
      left: 8px;
      font-size: 12px;
      opacity: 0.8;
    }

    #field-content {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
  </style>
</head>
<body>
  <div id="battle-screen">
    <!-- 左：ステータス画面 -->
    <div id="status-area" class="window">
      <div id="enemy-block">
        <div>【てき】</div>
        <div id="enemy-name"></div>
        <div id="enemy-hp"></div>
      </div>
      <div id="player-block">
        <div>【ステータス】</div>
        <div id="player-name"></div>
        <div id="player-lv"></div>
        <div id="player-hp"></div>
        <div id="player-exp"></div>   <!-- ← EXP追加 -->
      </div>
    </div>

    <!-- 中央：ログビュー＋コマンドビュー -->
    <div id="center-area">
      <div id="log-view" class="window">
        <div id="message-text"></div>
      </div>

      <div id="command-view" class="window">
        <button id="attack-btn" class="command-btn">たたかう</button>
        <button id="run-btn" class="command-btn">にげる</button>
      </div>
    </div>

    <!-- 右：フィールド画面 -->
    <div id="field-area" class="window">
      <div id="field-label">フィールド画面</div>
      <div id="field-content">
        ★ スライムが あらわれた ★
      </div>
    </div>
  </div>

  <script>
    // ============================
    // データ定義（EXP追加）
    // ============================
    const player = {
      name: "やまちゃん",
      level: 1,
      exp: 0,        // ← EXP追加
      hp: 20,
      maxHp: 20,
      attackMin: 3,
      attackMax: 6
    };

    const enemy = {
      name: "スライム",
      hp: 15,
      maxHp: 15,
      attackMin: 1,
      attackMax: 3,
      expGain: 5      // 倒した時に入る経験値
    };

    // "playerTurn" | "enemyTurn" | "win" | "lose" | "escape"
    let gameState = "playerTurn";
    let inputLocked = false;

    // ============================
    // DOM取得
    // ============================
    const enemyNameEl = document.getElementById("enemy-name");
    const enemyHpEl   = document.getElementById("enemy-hp");

    const playerNameEl = document.getElementById("player-name");
    const playerLvEl   = document.getElementById("player-lv");
    const playerHpEl   = document.getElementById("player-hp");
    const playerExpEl  = document.getElementById("player-exp"); // ← EXP DOM

    const messageTextEl = document.getElementById("message-text");

    const attackBtn = document.getElementById("attack-btn");
    const runBtn    = document.getElementById("run-btn");

    // ============================
    // ステータス更新（EXP対応）
    // ============================
    function updateStatus() {
      enemyNameEl.textContent = enemy.name;
      enemyHpEl.textContent   = "H P : " + enemy.hp + " / " + enemy.maxHp;

      playerNameEl.textContent = player.name;
      playerLvEl.textContent   = "L V : " + player.level;
      playerHpEl.textContent   = "H P : " + player.hp + " / " + player.maxHp;
      playerExpEl.textContent  = "E X P : " + player.exp;  // ← EXP追加表示
    }

    function setMessage(lines) {
      if (Array.isArray(lines)) {
        messageTextEl.textContent = lines.join("\n");
      } else {
        messageTextEl.textContent = lines;
      }
    }

    function lockInput() {
      inputLocked = true;
      attackBtn.disabled = true;
      runBtn.disabled    = true;
    }

    function unlockInput() {
      if (gameState === "playerTurn") {
        inputLocked = false;
        attackBtn.disabled = false;
        runBtn.disabled    = false;
      }
    }

    function endBattle() {
      attackBtn.disabled = true;
      runBtn.disabled    = true;
    }

    // ============================
    // プレイヤー攻撃
    // ============================
    function playerAttack() {
      if (inputLocked || gameState !== "playerTurn") return;

      lockInput();

      const damage = Math.floor(Math.random() * (player.attackMax - player.attackMin + 1)) + player.attackMin;
      enemy.hp -= damage;
      if (enemy.hp < 0) enemy.hp = 0;
      updateStatus();

      setMessage([
        player.name + "の こうげき！",
        enemy.name + "に " + damage + " の ダメージ！"
      ]);

      setTimeout(() => {
        if (enemy.hp <= 0) {
          // ===== 勝利処理（EXP加算） =====
          player.exp += enemy.expGain;
          updateStatus();

          gameState = "win";
          setMessage([
            enemy.name + "を たおした！",
            enemy.expGain + "ポイントの けいけんち！"
          ]);
          endBattle();
        } else {
          gameState = "enemyTurn";
          enemyAttack();
        }
      }, 800);
    }

    // ============================
    // 敵攻撃
    // ============================
    function enemyAttack() {
      if (gameState !== "enemyTurn") return;

      const damage = Math.floor(Math.random() * (enemy.attackMax - enemy.attackMin + 1)) + enemy.attackMin;
      player.hp -= damage;
      if (player.hp < 0) player.hp = 0;
      updateStatus();

      setMessage([
        enemy.name + "の こうげき！",
        player.name + "は " + damage + " の ダメージを うけた！"
      ]);

      setTimeout(() => {
        if (player.hp <= 0) {
          gameState = "lose";
          setMessage([
            player.name + "は しんでしまった…",
            "めのまえが まっくらに なった。"
          ]);
          endBattle();
        } else {
          gameState = "playerTurn";
          unlockInput();
          setMessage("コマンド？");
        }
      }, 800);
    }

    // ============================
    // にげる
    // ============================
    function tryEscape() {
      if (inputLocked || gameState !== "playerTurn") return;

      lockInput();

      const escaped = Math.random() < 0.5;

      if (escaped) {
        gameState = "escape";
        setMessage("うまく にげきれた！");
        endBattle();
      } else {
        setMessage([
          "しかし まわりこまれてしまった！",
          enemy.name + "の こうげき！"
        ]);

        setTimeout(() => {
          gameState = "enemyTurn";
          enemyAttack();
        }, 800);
      }
    }

    // ============================
    // 初期化
    // ============================
    attackBtn.addEventListener("click", playerAttack);
    runBtn.addEventListener("click", tryEscape);

    function initBattle() {
      updateStatus();
      setMessage(enemy.name + "が あらわれた！");
      gameState = "playerTurn";
      inputLocked = false;
      attackBtn.disabled = false;
      runBtn.disabled    = false;
    }

    initBattle();
  </script>
</body>
</html>
